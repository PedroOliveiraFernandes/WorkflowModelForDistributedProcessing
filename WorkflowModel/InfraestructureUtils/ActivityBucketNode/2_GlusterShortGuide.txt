### Exemplo gluster com 3 máquinas

# Passo 1
# É necessário criar 3 máquinas virtuais no GCP com o sistema operativo Ubuntu versão 18.04 LTS
# Nomeei as máquinas como server1, server2 e server3
# (não é necessário qualquer tipo de permissão especial de segurança nem nenhuma regra da Firewall)



# Passo 2
# É necessário executar os seguintes comandos para a instalação do gluster em todas as máquinas virtuais:

sudo add-apt-repository ppa:gluster/glusterfs-7
sudo apt update
sudo apt install glusterfs-server
sudo service glusterd start
sudo iptables -I INPUT -p all -j ACCEPT
# Pode ser util observar o estado do serviço gluster em execução através do comando:
sudo service glusterd status


# Passo 3
# É necessário associar os ips das máquinas a hostnames. 
# Esta associação pode ser feita alterando o ficheiro /etc/hosts com o seguinte comando:

sudo nano /etc/hosts

# A associação necessita de ser:
# Em todas as máquinas associar os ips internos das máquinas aos hostnames respectivos
# Segue um exemplo de como o ficheiro /etc/hosts em cada máquina poderia ficar

127.0.0.1 localhost
node1 10.128.0.4
node2 10.128.0.5
node3 10.128.0.6


# Passo 4
# É agora necessário interligar as máquinas virtuais através do comando: gluster peer probe serverx
# Em server1 executar:
sudo gluster peer probe node2
sudo gluster peer probe node3

# Pode ser util observar o estado da interligação dos nós do gluster através do comando:
sudo service glusterd status



# Passo 5
# É necessário executar o comando seguinte em todas as máquinas:
sudo mkdir -p /data/brick/gv0

# De forma a manter a consistencia com a documentação do gluster, cada máquina deveria ter um brick diferente
# pelo que para os servers 1,2 e 3 os comandos seriam

#server1
sudo mkdir -p /data/brick/gv0

#server2
sudo mkdir -p /data/brick/gv0

#server3
sudo mkdir -p /data/brick/gv0


# Passo 6
# É necessário executar numa das máquinas os comandos seguintes(executei no server1):
sudo gluster volume create gv0 replica 3 node1:/data/brick/gv0 node2:/data/brick/gv0 node3:/data/brick/gv0 force
sudo gluster volume start gv0


////


### Neste ponto o sistema distribuido encontra-se em funcionamento, e é acessivel a partir de qualquer máquina a partir da pasta /data/brick1/gv0
### No entanto é possivel fazer uma mount do volume do gluster para uma outra pasta do sistema de ficheiros da máquina virtual
### Isto pode ser obtido executando os seguintes comandos em todas as máquinas

sudo mkdir workdir
sudo mount -t glusterfs server1:/gv0 ./workdir

#Assim é possivel aceder ao volume do gluster em qualquer máquina a partir da pasta ./workdir




### Dependendo do estado de ligação entre os nós, obtido com o comando abaixo, pode ser necessário repetir o passo 4, Ao reiniciar a máquina
sudo gluster peer status







